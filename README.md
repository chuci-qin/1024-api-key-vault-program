# 1024 API Key Vault Program

> A non-custodial vault with multi-API-key authorization for 1024EX on Solana/1024Chain

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)
[![Rust](https://img.shields.io/badge/rust-1.75%2B-orange.svg)](https://www.rust-lang.org/)
[![Solana](https://img.shields.io/badge/solana-1.18-blue.svg)](https://solana.com/)

## ğŸŒŸ Features

- âœ… **Non-Custodial**: Project team has NO access to user funds
- âœ… **Multi-API-Key**: Create multiple API keys for different strategies
- âœ… **Fine-Grained Permissions**: Trade / Withdraw / Close-only / View-only
- âœ… **Risk Limits**: Independent notional limits for each API key
- âœ… **Revocable**: Instantly revoke any API key at any time
- âœ… **Unified Margin**: Single collateral pool for all 1024 products

## ğŸ“Š Why Vault + API Key?

| Feature | Traditional CEX | 1024 Vault | Advantage |
|---------|----------------|------------|-----------|
| **Custody** | Exchange holds keys | Smart contract custody | **Non-custodial** |
| **API Keys** | Generated by exchange | Generated by user locally | **Full control** |
| **Revocation** | Request to exchange | Instant on-chain | **Immediate** |
| **Permissions** | Limited options | Granular bit-mask | **Flexible** |
| **Limits** | Global limits | Per-key limits | **Risk management** |

## ğŸ—ï¸ Architecture

### Core Accounts

1. **GlobalConfig** (Singleton PDA)
   - Stores USDC mint address
   - Admin authority (can be revoked for full non-custody)

2. **UserVault** (One per user)
   - User's dedicated margin vault
   - Tracks free/locked collateral
   - Owned by program, controlled by logic

3. **DelegateAccount** (One per API key)
   - Represents a single API key authorization
   - Permissions, limits, expiry
   - Revocable by user

4. **Vault USDC Token Account** (One per vault)
   - Actual USDC storage
   - Owned by program PDA

### Permission System

```rust
PERM_TRADE       = 1 << 0  // Allow opening/closing positions
PERM_WITHDRAW    = 1 << 1  // Allow withdrawing funds
PERM_CLOSE_ONLY  = 1 << 2  // Only allow reducing positions
PERM_VIEW_ONLY   = 1 << 3  // Read-only access (future)
```

### PDA Seeds

```
GlobalConfig:      ["global", version]
UserVault:         ["vault", owner_wallet]
VaultTokenAccount: ["vault-usdc", owner_wallet]
DelegateAccount:   ["delegate", owner_wallet, delegate_pubkey]
```

## ğŸš€ Quick Start

### Prerequisites

- Rust 1.75+
- Solana CLI 1.18+
- 1024Chain CLI (for testnet deployment)

### Build

```bash
cargo build-sbf
```

### Test

```bash
cargo test-sbf
```

### Deploy

```bash
# Deploy to Solana devnet
solana program deploy target/deploy/vault_program.so

# Or deploy to 1024Chain testnet
1024chain program deploy target/deploy/vault_program.so
```

## ğŸ“– Usage Example

### 1. Initialize Global Config (One-time, by admin)

```rust
InitializeGlobalConfig {
    usdc_mint: <USDC_MINT_PUBKEY>
}
```

### 2. Create User Vault

```rust
CreateVault
// Signer: User's wallet
```

### 3. Deposit USDC

```rust
Deposit {
    amount: 10_000_000_000  // 10,000 USDC (e6 format)
}
```

### 4. Create API Key for Strategy

```rust
UpsertDelegate {
    delegate_pubkey: <API_KEY_PUBKEY>,
    permissions: PERM_TRADE,  // Allow trading only
    max_notional: 5_000_000_000,  // Max 5,000 USDC notional
    expiry_slot: <CURRENT_SLOT + 30_DAYS>
}
```

### 5. Strategy Uses API Key to Trade

The strategy (running on user's own server) uses the API key to sign transactions:

```rust
// Called by perpetual program via CPI
LockMargin {
    required_margin: 1_000_000_000,  // 1,000 USDC
    required_notional: 10_000_000_000  // 10,000 USDC notional
}
```

### 6. Revoke API Key

```rust
RevokeDelegate {
    delegate_pubkey: <API_KEY_PUBKEY>
}
// Immediately invalidates the API key
```

### 7. Withdraw Funds

```rust
Withdraw {
    amount: 5_000_000_000  // 5,000 USDC
}
```

## ğŸ” Non-Custodial Architecture

### How is it Non-Custodial?

1. **No Private Keys Held**: 
   - Project team never holds user's private keys
   - API keys are generated and stored by users themselves

2. **Smart Contract Custody**:
   - Funds are held by immutable program logic
   - No "admin withdraw" or backdoor functions

3. **User Control**:
   - Only user's wallet can create/revoke API keys
   - Only user's wallet can withdraw to their own address

4. **Transparent Logic**:
   - All rules enforced on-chain
   - Auditable by anyone

### Trust Model

```
User's Funds
    â†“
Stored in: Vault USDC Token Account (PDA)
    â†“
Controlled by: Program Logic (Immutable)
    â†“
Authorized by: User's Wallet OR Valid Delegate
    â†“
No unilateral access by project team
```

## ğŸ› ï¸ Development

### Project Structure

```
1024-api-key-vault-program/
â”œâ”€â”€ programs/vault/
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ lib.rs           # Program entrypoint
â”‚       â”œâ”€â”€ state.rs         # Account structures
â”‚       â”œâ”€â”€ instruction.rs   # Instruction definitions
â”‚       â”œâ”€â”€ processor.rs     # Instruction handlers
â”‚       â”œâ”€â”€ error.rs         # Error types
â”‚       â””â”€â”€ utils.rs         # Helper functions
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ vault_basic_flow.rs
â”‚   â””â”€â”€ delegate_permissions.rs
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ DEVELOPMENT_PROGRESS.md
â”‚   â”œâ”€â”€ design.md
â”‚   â””â”€â”€ draft.md
â”œâ”€â”€ Cargo.toml
â””â”€â”€ README.md
```

### Running Tests

```bash
# Unit tests
cargo test

# Integration tests (requires solana-test-validator)
cargo test-sbf

# Specific test
cargo test-sbf test_create_vault
```

## ğŸ“ Documentation

- [Development Progress](docs/DEVELOPMENT_PROGRESS.md) - Current development status
- [Design Document](docs/design.md) - Detailed technical design
- [Draft Specification](docs/draft.md) - Initial design notes

## ğŸ¤ Contributing

We welcome contributions! Please see [CONTRIBUTING.md](CONTRIBUTING.md) for guidelines.

### Development Workflow

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Write/update tests
5. Submit a pull request

## ğŸ“œ License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.

## ğŸ”— Links

- **1024EX**: https://1024ex.com
- **1024Chain**: https://1024chain.com
- **Documentation**: https://docs.1024.com
- **GitHub**: https://github.com/1024-org/1024-api-key-vault-program

## ğŸ’¬ Support

- Discord: https://discord.gg/1024ex
- Telegram: https://t.me/1024ex
- Email: support@1024.com

## âš ï¸ Disclaimer

This software is provided "as is", without warranty of any kind. Use at your own risk. Always audit smart contracts before deploying to mainnet.

---

**Built with â¤ï¸ by the 1024 team**

